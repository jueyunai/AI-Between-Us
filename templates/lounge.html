<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒ…æ„Ÿå®¢å… - æƒ…æ„Ÿé™ªä¼´åŠ©æ‰‹</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
</head>
<body class="lounge-page">
    <div class="container">
        <div class="chat-container">
            <div class="chat-header">
                <button class="back-btn" onclick="window.location.href='/home'">â† è¿”å›</button>
                <h2>ğŸ’‘ æƒ…æ„Ÿå®¢å…</h2>
                <div class="ai-icon" ondblclick="callAI()" title="åŒå‡»å¬å”¤AIåŠ©æ‰‹">AI</div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- æ¶ˆæ¯åˆ—è¡¨ -->
            </div>

            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="è¯´è¯´ä½ çš„æƒ³æ³•... (è¾“å…¥@AIå¯å¬å”¤åŠ©æ‰‹)" onkeypress="handleEnter(event)">
                <button class="send-btn" onclick="sendMessage()">å‘é€</button>
            </div>
        </div>
    </div>

    <div class="gentle-shape gentle-shape-1" aria-hidden="true"></div>
    <div class="gentle-shape gentle-shape-2" aria-hidden="true"></div>
    <div class="gentle-shape gentle-shape-3" aria-hidden="true"></div>

    <script>
        let socket = null;
        let roomId = null;
        let userId = null;
        let messages = [];

        async function init() {
            // è·å–ç”¨æˆ·ä¿¡æ¯
            const userResponse = await fetch('/api/user/info');

            // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°ç™»å½•
            if (userResponse.status === 401) {
                alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                window.location.href = '/';
                return;
            }

            const userData = await userResponse.json();

            if (!userData.success || !userData.user.has_partner) {
                alert('æ‚¨è¿˜æ²¡æœ‰ç»‘å®šä¼´ä¾£ï¼Œæ— æ³•è¿›å…¥æƒ…æ„Ÿå®¢å…');
                window.location.href = '/home';
                return;
            }

            userId = userData.user.id;

            // è·å–æˆ¿é—´ä¿¡æ¯
            const roomResponse = await fetch('/api/lounge/room');

            if (roomResponse.status === 401) {
                alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                window.location.href = '/';
                return;
            }

            const roomData = await roomResponse.json();

            if (!roomData.success) {
                alert('æ— æ³•è·å–æˆ¿é—´ä¿¡æ¯');
                window.location.href = '/home';
                return;
            }

            roomId = roomData.room_id;

            // åŠ è½½å†å²è®°å½•
            await loadHistory();

            // è¿æ¥ WebSocket
            connectWebSocket();
        }

        async function loadHistory() {
            try {
                const response = await fetch('/api/lounge/history');
                const data = await response.json();

                if (data.success) {
                    messages = data.messages;
                    renderMessages();
                }
            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥', error);
            }
        }

        function connectWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/lounge/${roomId}`;

            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                console.log('WebSocket å·²è¿æ¥');
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.event === 'new_message') {
                    messages.push(data.message);
                    renderMessages();
                }
            };

            socket.onclose = () => {
                console.log('WebSocket å·²æ–­å¼€');
            };

            socket.onerror = (error) => {
                console.error('WebSocket é”™è¯¯:', error);
            };
        }

        function renderMessages() {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';

            messages.forEach(msg => {
                const messageDiv = document.createElement('div');

                if (msg.role === 'assistant') {
                    messageDiv.className = 'message assistant';
                } else if (msg.user_id === userId) {
                    messageDiv.className = 'message user';
                } else {
                    messageDiv.className = 'message partner';
                }

                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = msg.content;

                messageDiv.appendChild(contentDiv);
                container.appendChild(messageDiv);
            });

            // æ»šåŠ¨åˆ°åº•éƒ¨
            container.scrollTop = container.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content) return;

            // æ£€æŸ¥æ˜¯å¦å¬å”¤ AI
            if (content.includes('@AI')) {
                callAI();
                input.value = '';
                return;
            }

            // å‘é€æ¶ˆæ¯
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    event: 'send_message',
                    user_id: userId,
                    content: content
                }));
            }

            input.value = '';
        }

        function callAI() {
            // æ˜¾ç¤º AI æ­£åœ¨å“åº”
            const loadingMsg = {
                role: 'assistant',
                content: 'ğŸ¤– AIåŠ©æ‰‹æ­£åœ¨åˆ†æä½ ä»¬çš„å¯¹è¯...'
            };
            messages.push(loadingMsg);
            renderMessages();

            // å¬å”¤ AI
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    event: 'call_ai'
                }));
            }

            // ç§»é™¤åŠ è½½æ¶ˆæ¯ï¼ˆå®é™…æ¶ˆæ¯ä¼šé€šè¿‡ WebSocket æ¥æ”¶ï¼‰
            setTimeout(() => {
                messages = messages.filter(m => m.content !== loadingMsg.content);
                renderMessages();
            }, 500);
        }

        function handleEnter(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
